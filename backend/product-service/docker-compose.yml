version: "3.9"

services:
#  mongo:
#    image: mongo:7
#    container_name: mongo
#    restart: always
#    ports:
#      - "27017:27017"
#    healthcheck:
#      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
#      interval: 10s
#      timeout: 5s
#      retries: 5
#    volumes:
#      - mongo_data:/data/db
#      - ./mongo_backups:/backups
#    networks:
#      - product-net
#
#  mongo-backup:
#    image: mongo:7
#    container_name: mongo-backup
#    depends_on:
#      - mongo
#    volumes:
#      - ./mongo_backups:/backup
#      - product-service_mongo_data:/data/db
#    entrypoint: >
#      bash -c "while true; do
#        echo 'üîÅ Running MongoDB backup...';
#        mongodump --host mongo --out /backup/$(date +%F_%H-%M-%S);
#        find /backup -type d -mtime +7 -exec rm -rf {} \;
#        sleep 86400;
#      done"
#    networks:
#      - product-net
  eureka-server:
    build: ../eureka-server
    container_name: eureka-server
    ports:
      - "8761:8761"
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8761/eureka/actuator/health || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - product-net

  api-gateway:
    build: ../api-gateway
    container_name: api-gateway
    environment:
      - SPRING_REDIS_HOST=redis
      - JWT_SECRET=supersecretkeythatshouldbereplacedandstoredsecurely
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/eureka/
    ports:
      - "8080:8080"
    depends_on:
        - eureka-server
        - auth-service
        - user-service
        - product-service
        - order-service
        - payment-service
        - inventory-service
        - category-service
        - cart-service
        - coupon-service
        - review-service
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8080/actuator/health || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
        - product-net

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.3
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false

      # Correct CORS settings
#      - http.cors.enabled=true
#      - http.cors.allow-origin="*"
#      - http.cors.allow-credentials=true
#      - http.cors.allow-headers="X-Requested-With, X-Auth-Token, Content-Type, Content-Length, Authorization"
#      - http.cors.allow-methods="OPTIONS, HEAD, GET, POST, PUT, DELETE"

    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
#      - ./elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
      - es_data:/usr/share/elasticsearch/data
    networks:
      - product-net

  elasticvue:
    image: cars10/elasticvue
    container_name: elasticvue
    environment:
      - LISTEN_PORT=8080
      - SERVER_BASEPATH=/elastic/
      - SERVER_DEFAULT_CLUSTER=http://elasticsearch:9200
    ports:
      - "9999:8080"
    volumes:
      - /root/elasticvue-config/config.js:/usr/share/nginx/html/config.js:ro
      - /root/elasticvue-config/index.html:/usr/share/nginx/html/index.html:ro
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - product-net

  product-service:
    build: .
    container_name: product-service
    depends_on:
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      kafka:
        condition: service_healthy
      category-service:
        condition: service_healthy

    environment:
      - CATEGORY_SERVICE_URL=http://category-service:8082/api/v1/category
      - ELASTIC_URI=http://elasticsearch:9200
      - JWT_SECRET=supersecretkeythatshouldbereplacedandstoredsecurely
      - SERVER_PORT=8081
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - LOGSTASH_HOST=logstash
      - LOGSTASH_PORT=5000
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8081/actuator/health || exit 1" ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    extra_hosts:
      - "host.docker.internal:172.17.0.1"
    ports:
      - "8081:8081"
    networks:
      - product-net

  category-service:
    build: ../category-service
    container_name: category-service
    depends_on:
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    environment:
      - PRODUCT_SERVICE_URL=http://product-service:8081/api/v1/product
      - ELASTIC_URI=http://elasticsearch:9200
      - JWT_SECRET=supersecretkeythatshouldbereplacedandstoredsecurely
      - SERVER_PORT=8082
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - LOGSTASH_HOST=logstash
      - LOGSTASH_PORT=5000
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8082/actuator/health || exit 1" ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    extra_hosts:
      - "host.docker.internal:172.17.0.1"
    ports:
      - "8082:8082"
    networks:
      - product-net

  inventory-service:
    build: ../inventory-service
    container_name: inventory-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://host.docker.internal:5432/inventory_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JWT_SECRET=supersecretkeythatshouldbereplacedandstoredsecurely
      - SERVER_PORT=8083
      - LOGSTASH_HOST=logstash
      - LOGSTASH_PORT=5000
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8083/actuator/health || exit 1" ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    extra_hosts:
      - "host.docker.internal:172.17.0.1"
    ports:
      - "8083:8083"
    depends_on:
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      kafka:
        condition: service_healthy
      product-service:
        condition: service_healthy
    networks:
      - product-net

  order-service:
    build: ../order-service
    container_name: order-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://host.docker.internal:5432/order_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - KAFKA_BOOTSTRAP=kafka:9092
      - JWT_SECRET=supersecretkeythatshouldbereplacedandstoredsecurely
      - SERVER_PORT=8084
      - LOGSTASH_HOST=logstash
      - LOGSTASH_PORT=5000
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8084/actuator/health || exit 1" ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    extra_hosts:
      - "host.docker.internal:172.17.0.1"
    ports:
      - "8084:8084"
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      product-service:
        condition: service_healthy
    networks:
      - product-net

  payment-service:
    build: ../payment-service
    container_name: payment-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://host.docker.internal:5432/payment_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JWT_SECRET=supersecretkeythatshouldbereplacedandstoredsecurely
      - SERVER_PORT=8085
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8085/actuator/health || exit 1" ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    extra_hosts:
      - "host.docker.internal:172.17.0.1"
    ports:
      - "8085:8085"
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - product-net

  user-service:
    build: ../user-service
    container_name: user-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://host.docker.internal:5432/user_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JWT_SECRET=supersecretkeythatshouldbereplacedandstoredsecurely
      - SERVER_PORT=8086
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8086/actuator/health || exit 1" ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    extra_hosts:
      - "host.docker.internal:172.17.0.1"
    ports:
      - "8086:8086"
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - product-net

  auth-service:
    build: ../auth-service
    container_name: auth-service
    environment:
      - USER_SERVICE_URL=http://user-service:8086
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JWT_SECRET=supersecretkeythatshouldbereplacedandstoredsecurely
      - SERVER_PORT=8087
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8087/actuator/health || exit 1" ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    ports:
      - "8087:8087"
    networks:
      - product-net
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
      user-service:
        condition: service_healthy

  cart-service:
    build: ../cart-service
    container_name: cart-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://host.docker.internal:5432/cart_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - KAFKA_BOOTSTRAP=kafka:9092
      - JWT_SECRET=supersecretkeythatshouldbereplacedandstoredsecurely
      - SERVER_PORT=8088
      - LOGSTASH_HOST=logstash
      - LOGSTASH_PORT=5000
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8088/actuator/health || exit 1" ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    extra_hosts:
      - "host.docker.internal:172.17.0.1"
    ports:
      - "8088:8088"
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      product-service:
        condition: service_healthy
    networks:
      - product-net

  coupon-service:
    build: ../coupon-service
    container_name: coupon-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://host.docker.internal:5432/coupon_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - KAFKA_BOOTSTRAP=kafka:9092
      - JWT_SECRET=supersecretkeythatshouldbereplacedandstoredsecurely
      - SERVER_PORT=8089
      - LOGSTASH_HOST=logstash
      - LOGSTASH_PORT=5000
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8089/actuator/health || exit 1" ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    extra_hosts:
      - "host.docker.internal:172.17.0.1"
    ports:
      - "8089:8089"
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      product-service:
        condition: service_healthy
    networks:
      - product-net

  review-service:
    build: ../review-service
    container_name: review-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://host.docker.internal:5432/review_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - KAFKA_BOOTSTRAP=kafka:9092
      - JWT_SECRET=supersecretkeythatshouldbereplacedandstoredsecurely
      - SERVER_PORT=8090
      - LOGSTASH_HOST=logstash
      - LOGSTASH_PORT=5000
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8090/actuator/health || exit 1" ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    extra_hosts:
      - "host.docker.internal:172.17.0.1"
    ports:
      - "8090:8090"
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      product-service:
        condition: service_healthy
    networks:
      - product-net

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD", "echo", "ruok", "|", "nc", "localhost", "2181", "|", "grep", "imok"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - product-net

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 10s
      timeout: 10s
      retries: 10
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - product-net

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "9093:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
      - SERVER_SERVLET_CONTEXT_PATH=/kafka
      - MANAGEMENT_SERVER_BASE_PATH=/kafka
    depends_on:
      - kafka
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:8080/kafka/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 10
    networks:
      - product-net

#  postgres:
#    image: postgres:15
#    container_name: postgres
#    environment:
#      POSTGRES_USER: postgres
#      POSTGRES_PASSWORD: postgres
#      POSTGRES_DB: inventory_db
#    ports:
#      - "5432:5432"
#    volumes:
#      - ./init-order-db.sql:/docker-entrypoint-initdb.d/init-order-db.sql
#      - pgdata:/var/lib/postgresql/data
#    networks:
#      - product-net

  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - product-net

#  kibana:
#    image: docker.elastic.co/kibana/kibana:8.15.3
#    container_name: kibana
#    environment:
#      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
#      - SERVER_NAME=kibana
#      - SERVER_HOST=0.0.0.0
#      - XPACK_SECURITY_ENABLED=false
#    ports:
#      - "5601:5601"
#    depends_on:
#      elasticsearch:
#        condition: service_healthy
#    healthcheck:
#      test: [ "CMD-SHELL", "curl -f http://localhost:5601/api/status | grep '\"state\":\"green\"' || exit 1" ]
#      interval: 30s
#      timeout: 10s
#      retries: 10
#      start_period: 40s
#    networks:
#      - product-net

#  logstash:
#    image: docker.elastic.co/logstash/logstash:8.5.3
#    container_name: logstash
#    volumes:
#      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro
#    ports:
#      - "5000:5000"     # TCP input for app logs
#      - "9600:9600"     # Logstash monitoring API
#    depends_on:
#      - elasticsearch
#    networks:
#      - product-net


#  # ---------- Prometheus ----------
#  prometheus:
#    image: prom/prometheus:latest
#    container_name: prometheus
#    volumes:
#      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
#      - ./monitoring/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
#    ports:
#      - "9090:9090"
#    command:
#      - '--config.file=/etc/prometheus/prometheus.yml'
#      - '--web.enable-lifecycle'  # allows reload via API
#    networks:
#      - product-net

#  grafana:
#    image: grafana/grafana:latest
#    container_name: grafana
#    user: "472" # avoid permission issues; optional
#    environment:
#      - GF_SECURITY_ADMIN_PASSWORD=admin
#      - GF_USERS_ALLOW_SIGN_UP=false
#    ports:
#      - "3000:3000"
#    depends_on:
#      - prometheus
#    volumes:
#      - grafana_data:/var/lib/grafana
#      - ./monitoring/dashboards:/var/lib/grafana/dashboards:ro
#      - ./monitoring/provisioning:/etc/grafana/provisioning:ro
#    networks:
#      - product-net

    # ---------- Kafka Exporter (broker metrics & consumer lag) ----------
#  kafka-exporter:
#    image: danielqsj/kafka-exporter:latest
#    container_name: kafka-exporter
#    environment:
#      - KAFKA_BROKERS=kafka:9092
#      - KAFKA_ZOOKEEPER=zookeeper:2181
#      # optional: specify topics regex or other envs per image docs
#    ports:
#      - "9308:9308"   # exporter metrics port
#    depends_on:
#      - kafka
#    networks:
#      - product-net
#
#    # optional: filebeat alternative if you prefer shipping log files instead of TCP
#  filebeat:
#    image: docker.elastic.co/beats/filebeat:8.10.0
#    container_name: filebeat
#    user: root
#    volumes:
#      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
#      - ./logs:/usr/share/filebeat/logs:ro
#      - /var/lib/docker/containers:/var/lib/docker/containers:ro
#      - /var/run/docker.sock:/var/run/docker.sock:ro
#    depends_on:
#      - logstash
#      - elasticsearch
#    networks:
#      - product-net

networks:
  product-net:
    driver: bridge

volumes:
  es_data:
  redis_data:
  pgdata:
#  grafana_data:
